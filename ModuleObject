
Функция ОсновнаяРабота(аргНужныйДокумент, аргМасЭлементовГрафическойСхемы) Экспорт
		
	нужныйЭлемент = аргМасЭлементовГрафическойСхемы.Найти("ЗаказПокупателя");
	
	Если Не аргНужныйДокумент = Неопределено 
		И Не аргНужныйДокумент = Документы.ЗаказПокупателя.ПустаяСсылка() 
		И Не аргНужныйДокумент.ПометкаУдаления
		И аргНужныйДокумент.Проведен Тогда
		
		нужныйЭлемент.Пояснение = "Проведён";
	Иначе
		
		нужныйЭлемент.Пояснение = "Нет документа";		
		Возврат Неопределено;
	КонецЕсли;
	
	нужныйЭлемент = аргМасЭлементовГрафическойСхемы.Найти("ПриходныйКассовыйОрдер");	
	масПриходныхКассовыхОрдеров = ЗапроситьПриходныеКассовыеОрдераПоЗаказуПокупателя(аргНужныйДокумент);		
	ОтобразитьСостояниеДокумента(нужныйЭлемент, масПриходныхКассовыхОрдеров);
	
	нужныйЭлемент = аргМасЭлементовГрафическойСхемы.Найти("РезервированиеТоваров");	
	масРезервированияТоваров = ЗапроситьРезервированиеТоваровПоЗаказуПокупателя(аргНужныйДокумент);		
	ОтобразитьСостояниеДокумента(нужныйЭлемент, масРезервированияТоваров); 
		
	нужныйЭлемент = аргМасЭлементовГрафическойСхемы.Найти("РеализацияТоваровУслуг");	
	масРеализацииТоваров = ЗапроситьРеализацииТоваровПоЗаказуПокупателя(аргНужныйДокумент);		
	ОтобразитьСостояниеДокумента(нужныйЭлемент, масРеализацииТоваров);
	
	нужныйЭлемент = аргМасЭлементовГрафическойСхемы.Найти("КорректировкаЗаказаПокупателя");	
	масКорректировокЗаказов = ЗапроситьРеализацииТоваровПоЗаказуПокупателя(аргНужныйДокумент);		
	ОтобразитьСостояниеДокумента(нужныйЭлемент, масКорректировокЗаказов);
	
	
	СоотвРезультаты = Новый Соответствие; 
	СоотвРезультаты.Вставить("ПриходныйКассовыйОрдер", масПриходныхКассовыхОрдеров);
	СоотвРезультаты.Вставить("РезервированиеТоваров", масРезервированияТоваров);
	СоотвРезультаты.Вставить("РеализацияТоваровУслуг", масРеализацииТоваров);
	СоотвРезультаты.Вставить("КорректировкаЗаказаПокупателя", масКорректировокЗаказов);
	
	
	Возврат СоотвРезультаты;
	
КонецФункции


Процедура ОтобразитьСостояниеДокумента(аргВыводнойЭлемент, аргМасДокументов)

	Если аргМасДокументов.Количество() = 1 Тогда
		аргВыводнойЭлемент.Пояснение = "Проведён";
	ИначеЕсли аргМасДокументов.Количество() > 1 Тогда
		аргВыводнойЭлемент.Пояснение = "Проведено " + аргМасДокументов.Количество() + " Документов";
	Иначе
		аргВыводнойЭлемент.Пояснение = "Нет документа";
	КонецЕсли;
		
КонецПроцедуры






Функция ЗапроситьРезервированиеТоваровПоЗаказуПокупателя(аргДокЗаказПокупателя)
	
	ЗапросРезервированиеТоваровПоЗаказуПокупателя = Новый Запрос();
	
	ЗапросРезервированиеТоваровПоЗаказуПокупателя.Текст = "ВЫБРАТЬ
	                                                      |	РезервированиеТоваров.Ссылка
	                                                      |ИЗ
	                                                      |	Документ.РезервированиеТоваров КАК РезервированиеТоваров
	                                                      |ГДЕ
	                                                      |	РезервированиеТоваров.Заказ = &нужныйЗаказ
	                                                      |	И НЕ РезервированиеТоваров.ПометкаУдаления
	                                                      |	И РезервированиеТоваров.Проведен";
	
	ЗапросРезервированиеТоваровПоЗаказуПокупателя.УстановитьПараметр("нужныйЗаказ", аргДокЗаказПокупателя);	
	
	
	Возврат ЗапросРезервированиеТоваровПоЗаказуПокупателя.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
		
КонецФункции



Функция ЗапроситьРеализацииТоваровПоЗаказуПокупателя(аргДокЗаказПокупателя)
	
	ЗапросРеализацииТоваровПоЗаказуПокупателя = Новый Запрос();
	
	ЗапросРеализацииТоваровПоЗаказуПокупателя.Текст = "ВЫБРАТЬ
	                                                  |	РеализацияТоваровУслуг.Ссылка
	                                                  |ИЗ
	                                                  |	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	                                                  |ГДЕ
	                                                  |	РеализацияТоваровУслуг.Сделка = &нужныйЗаказ
	                                                  |	И НЕ РеализацияТоваровУслуг.ПометкаУдаления
	                                                  |	И РеализацияТоваровУслуг.Проведен";
	
	ЗапросРеализацииТоваровПоЗаказуПокупателя.УстановитьПараметр("нужныйЗаказ", аргДокЗаказПокупателя);	
	
	
	Возврат ЗапросРеализацииТоваровПоЗаказуПокупателя.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
		
КонецФункции



Функция ЗапроситьКорректировкиЗаказаПокупателя(аргДокЗаказПокупателя)
	
	ЗапросКорректировокЗаказаПокупателя = Новый Запрос();
	
	ЗапросКорректировокЗаказаПокупателя.Текст = "ВЫБРАТЬ
	                                            |	КорректировкаЗаказаПокупателя.Ссылка
	                                            |ИЗ
	                                            |	Документ.КорректировкаЗаказаПокупателя КАК КорректировкаЗаказаПокупателя
	                                            |ГДЕ
	                                            |	КорректировкаЗаказаПокупателя.ЗаказПокупателя = &нужныйЗаказ
	                                            |	И НЕ КорректировкаЗаказаПокупателя.ПометкаУдаления
	                                            |	И КорректировкаЗаказаПокупателя.Проведен";
	
	ЗапросКорректировокЗаказаПокупателя.УстановитьПараметр("нужныйЗаказ", аргДокЗаказПокупателя);	
	
	
	Возврат ЗапросКорректировокЗаказаПокупателя.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
		
КонецФункции




Функция ЗапроситьПриходныеКассовыеОрдераПоЗаказуПокупателя(аргДокЗаказПокупателя)
	
	ЗапросПриходныеКассовыеОрдераПоЗаказуПокупателя = Новый Запрос();
	
	ЗапросПриходныеКассовыеОрдераПоЗаказуПокупателя.Текст = "ВЫБРАТЬ
	                                                        |	ПриходныйКассовыйОрдер.Ссылка
	                                                        |ИЗ
	                                                        |	Документ.ПриходныйКассовыйОрдер КАК ПриходныйКассовыйОрдер
	                                                        |ГДЕ
	                                                        |	ПриходныйКассовыйОрдер.РасшифровкаПлатежа.Сделка = &нужныйЗаказ";
	
	ЗапросПриходныеКассовыеОрдераПоЗаказуПокупателя.УстановитьПараметр("нужныйЗаказ", аргДокЗаказПокупателя);	
	
	
	Возврат ЗапросПриходныеКассовыеОрдераПоЗаказуПокупателя.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
		
КонецФункции

